# 植物大战僵尸 - 金币系统逆向分析

## 📌 分析目标
分析金币的增加、减少、验证和存储机制

---

## 🎯 核心函数

### 1. **`sub_701D78` (0x701D78)** - 金币修改核心函数
**位置**: `libpvz.so` @ 0x701D78  
**大小**: 0x4A0 字节

#### 函数原型
```c
__int64 __fastcall sub_701D78(
    __int64 a1,      // 金币管理器对象指针
    int a2,          // 金币变化量 (正=增加, 负=减少)
    char a3,         // 标志位 (1=修改总金币, 0=修改临时金币)
    __int64 a4,      // 场景/来源字符串
    __int64 a5,      // 事件名称
    __int64 a6       // 额外信息
)
```

#### 内存布局
```
金币管理器对象:
+0x00 : int64  - 总金币 (无上限)
+0x08 : int32  - 临时金币/银币 (上限 999,999)
+0x10 : ptr    - 游戏数据指针
```

#### 金币增加逻辑
```c
if (a2 > 0) {
    if ((a3 & 1) != 0) {
        // 增加到总金币 (永久)
        *(int64*)(a1 + 0x00) += a2;
    } else {
        // 增加到临时金币 (本局游戏)
        *(int32*)(a1 + 0x08) += a2;
    }
    
    // 禅境花园特殊处理
    if (游戏模式 == 禅境花园 && a2 > 0) {
        *(int32*)(a1 + 15248) += a2;  // 累计收集的金币
    }
}
```

#### 金币减少逻辑
```c
if (a2 < 0) {
    int amount = abs(a2);
    int deficit = amount - *(int32*)(a1 + 0x08);
    
    // 先从临时金币扣除
    *(int32*)(a1 + 0x08) = max(*(int32*)(a1 + 0x08) - amount, 0);
    
    // 如果临时金币不够,从总金币扣除差额
    if (deficit > 0) {
        *(int64*)(a1 + 0x00) = max(*(int64*)(a1 + 0x00) - deficit, 0);
    }
}
```

#### 金币上限验证
```c
// 临时金币上限检查
if (*(int32*)(a1 + 0x08) > 999999) {
    *(int32*)(a1 + 0x08) = 999999;
}

// 临时金币下限检查
if (*(int32*)(a1 + 0x08) < 0) {
    *(int32*)(a1 + 0x08) = 0;
}

// 注意: 总金币没有上限!
```

---

### 2. **`sub_70376C` (0x70376C)** - 商店购买处理
**功能**: 处理商店物品购买,扣除金币,更新购买状态

#### 关键代码片段
```c
// 参数检查
if (商品ID < 0 || 商品ID >= 64) {
    return false;
}

// 更新商品状态
原状态 = *(int32*)(a1 + 15288 + 4 * 商品ID);
*(int32*)(a1 + 15288 + 4 * 商品ID) = 新状态;

// 只有从未购买(非3)变为已购买(3)才处理
if (原状态 != 3 && 新状态 == 3) {
    // 调用金币扣除函数
    sub_701D78(a1, 金币数量/10, 1, "StoreScreen", "", "OnPurchaseCoins");
    
    // 发送购买统计
    // Event ID: 40012
    // 参数: 商品名称, 等级, 金币数量
}
```

---

### 3. **`sub_6AD768` (0x6AD768)** - 金币分析/跟踪
**功能**: 收集游戏数据用于分析,包含金币余额追踪

**特征**:
- 引用 `"CoinBalance"` 字符串
- 大型函数 (超过3000行反编译代码)
- 收集多个游戏指标发送到服务器

---

## 🔍 相关字符串

### 金币相关
- `"CoinBalance"` @ 0x172800B
- `"OnPurchaseCoins"` @ 0x1729404
- `"GetCoins"` @ 0x171F7A6
- `"COINS_FOR_AD"` @ 0x1722948
- `"coins"` @ 0x172269B

### 金币资源
- `"reanim/coin_silver.reanim"` @ 0x17255C1
- `"reanim/coin_gold.reanim"` @ 0x1725E37
- `"SOUND_COIN"` @ 0x17419F9
- `"IMAGE_COINBANK"` @ 0x1730C02

---

## 💰 金币类型

### 1. 总金币 (Permanent Coins)
- **存储**: `对象 + 0x00` (int64)
- **用途**: 用于购买商店物品
- **特点**: 跨关卡保存,无上限

### 2. 临时金币 (Temporary/Silver Coins)
- **存储**: `对象 + 0x08` (int32)
- **用途**: 本局游戏内使用
- **上限**: 999,999
- **特点**: 游戏结束后重置

---

## 🛠️ 修改方法

### 方法1: 内存修改
```
1. 定位金币管理器对象
2. 修改偏移:
   - +0x00 (8字节) = 总金币
   - +0x08 (4字节) = 临时金币
3. 注意临时金币会被限制在 0-999999
```

### 方法2: Hook函数调用
```
Hook函数: sub_701D78
修改参数 a2 为任意大数值
设置参数 a3 = 1 (修改总金币)
```

### 方法3: 修改购买验证
```
在 sub_70376C 中:
- 跳过金币扣除调用
- 或修改扣除金额为0
```

---

## ⚠️ 注意事项

1. **总金币无上限**: 可以设置为极大值
2. **临时金币有限制**: 超过999,999会被重置
3. **数据追踪**: 金币变化会被记录并上传服务器
4. **存档保存**: 总金币会保存到存档文件

---

## 📊 分析工具使用

**IDA Pro 分析**:
```
关键函数:
- sub_701D78: 金币修改核心
- sub_70376C: 购买处理
- sub_602830: 金币验证辅助
- sub_702F0C: 金币计算辅助
```

**调试断点**:
```
0x701D78  - 金币修改入口
0x701DEC  - 金币增加分支
0x701E70  - 金币减少分支
0x702158  - 金币上限检查
```

---

*分析日期: 2025-10-20*  
*工具: IDA Pro 8.x + ida-pro-mcp*  
*目标: libpvz.so (arm64-v8a)*

