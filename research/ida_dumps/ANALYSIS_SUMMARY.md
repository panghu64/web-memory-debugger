# PVZé˜³å…‰ç³»ç»Ÿ - IDAåˆ†ææ€»ç»“

## ğŸ“Œ åˆ†ææ—¥æœŸ
2025-10-20

## ğŸ¯ åˆ†æç›®æ ‡
æ‰¾åˆ°è¿è¡Œæ—¶é˜³å…‰å€¼çš„é™æ€åŸºåœ°å€å’Œåç§»é“¾

---

## âœ… å·²ç¡®è®¤çš„C++ç±»ç»“æ„

### 1. Boardç±»
- **æ„é€ å‡½æ•°**: `0x606834` (`sub_606834`)
- **ææ„å‡½æ•°**: `0x60907C` (`sub_60907C`)
- **vtable**: `0x1B13B20` (`_ZTV5Board`)
- **å¯¹è±¡å¤§å°**: `0x5B98` (23448å­—èŠ‚)
- **å…³é”®å­—æ®µ**:
  - `+0x118` (280): `LawnApp*` æŒ‡å‘çˆ¶å¯¹è±¡
  - `+???`: è¿è¡Œæ—¶é˜³å…‰å€¼ (ä½ç½®æœªç¡®å®š)

### 2. LawnAppç±»
- **vtable**: `0x1B159C8` (`_ZTV7LawnApp`)
- **å…³é”®å­—æ®µ**:
  - `+0xB68` (2920): `Board*` æŒ‡å‘æ¸¸æˆæ£‹ç›˜å¯¹è±¡
- **åˆ›å»ºBoard**: `sub_674C24` (`LawnApp::MakeNewBoard`)

### 3. PvZApplicationç±»
- **vtable**: `0x1AF5E38` (`_ZTVN2EA15PlantsVsZombies14PvZApplicationE`)
- **æ„é€ å‡½æ•°**: `0x327120`

### 4. å…³å¡é…ç½®ç»“æ„
- **XMLè§£æå‡½æ•°**: `0x69C5C8` (`sub_69C5C8`)
- **åˆå§‹é˜³å…‰åç§»**: `+0xE7C` (3708) - è¿™æ˜¯**é…ç½®å€¼**ï¼Œéè¿è¡Œæ—¶å€¼
- **å…³å¡æ•°æ®å¤§å°**: 636å­—èŠ‚/å…³å¡

---

## âŒ æœªè§£å†³çš„é—®é¢˜

### 1. å…¨å±€LawnAppå®ä¾‹
**é—®é¢˜**: æœªæ‰¾åˆ°å…¨å±€å˜é‡æˆ–é™æ€æŒ‡é’ˆæŒ‡å‘LawnAppå®ä¾‹

**æœç´¢å°è¯•**:
- æœç´¢æ¨¡å¼: `gApp`, `gLawn`, `gBoard`, `theApp`, `sApp`
- ç»“æœ: å…¨éƒ¨ä¸ºç©º

**å¯èƒ½åŸå› **:
- ä½¿ç”¨äº†éæ ‡å‡†å‘½å
- é€šè¿‡JNIåœ¨Javaå±‚ç®¡ç†ï¼ŒC++å±‚æ— å…¨å±€å˜é‡
- ä½¿ç”¨äº†æŸç§å•ä¾‹æ¨¡å¼ï¼Œéœ€è¦é€šè¿‡å‡½æ•°è®¿é—®

### 2. è¿è¡Œæ—¶é˜³å…‰å€¼ä½ç½®
**é—®é¢˜**: Boardç±»ä¸­è¿è¡Œæ—¶é˜³å…‰å­—æ®µçš„åç§»æœªç¡®å®š

**å·²çŸ¥**:
- é…ç½®ä¸­çš„åˆå§‹é˜³å…‰åœ¨ `+0xE7C` (ä»…ç”¨äºåŠ è½½æ—¶è®¾ç½®)
- è¿è¡Œæ—¶é˜³å…‰åº”è¯¥åœ¨Boardå¯¹è±¡çš„æŸä¸ªåç§»å¤„
- æœªæ‰¾åˆ°æ˜ç¡®çš„AddSun/GetSun/SetSunæ–¹æ³•å¼•ç”¨

**å…³é”®è¯æ®**:
æ ¹æ®ä¹‹å‰çš„ç¡¬ä»¶æ–­ç‚¹åˆ†æï¼š
```
é˜³å…‰åœ°å€: 0x7ACC02887C
å†…å­˜åŒºåŸŸ: dalvik-main space (Javaå †)
è®¿é—®ä»£ç : /system/framework/arm64/boot-framework.oat
å…³é”®æŒ‡ä»¤: ldr x21, [x21] (0x71e51048)
```

**ç»“è®º**: è¿è¡Œæ—¶é˜³å…‰å€¼å¾ˆå¯èƒ½**ä¸åœ¨C++ Boardç±»ä¸­**ï¼Œè€Œæ˜¯åœ¨**Javaå¯¹è±¡ä¸­**ï¼

---

## ğŸ” Javaå±‚è¯æ®

### å†…å­˜è®¿é—®è·¯å¾„åˆ†æ

ä»ç¡¬ä»¶æ–­ç‚¹æ•è·çš„ä¿¡æ¯ï¼š

1. **è§¦å‘æŒ‡ä»¤**: `0x71e51048` in `boot-framework.oat`
   ```
   ldr x21, [x21]
   ```
   - è¿™æ˜¯Java/Kotlinç¼–è¯‘åçš„Nativeä»£ç 
   - `X21` åŒ…å«äº†é˜³å…‰å€¼çš„åœ°å€

2. **ä¸­é—´å¯¹è±¡**: `X1 = 0x30b0338` (åœ¨ `dalvik-main space`)
   - è¿™æ˜¯ä¸€ä¸ªJavaå¯¹è±¡å¼•ç”¨
   - è¯¥å¯¹è±¡åŒ…å«äº†æŒ‡å‘å®é™…é˜³å…‰å€¼çš„æŒ‡é’ˆ

3. **é˜³å…‰å€¼åœ°å€**: `0x7ACC02887C`
   - åœ¨Javaå †ä¸­
   - åŠ¨æ€åˆ†é…ï¼Œæ¯æ¬¡è¿è¡Œå¯èƒ½å˜åŒ–

---

## ğŸ’¡ åˆ†æç»“è®º

### C++é™æ€æŒ‡é’ˆé“¾ä¸é€‚ç”¨

**åŸå› **:
1. é˜³å…‰å€¼å­˜å‚¨åœ¨Javaå † (GCç®¡ç†ï¼Œåœ°å€åŠ¨æ€)
2. è®¿é—®ä»£ç åœ¨Java/Kotlinå±‚ (`boot-framework.oat`)
3. æ²¡æœ‰ä»C++ `libpvz.so` åˆ°Javaå †çš„é™æ€æŒ‡é’ˆ

### å¯èƒ½çš„æ¶æ„è®¾è®¡

```
Javaå±‚ (PvZåº”ç”¨ä¸»é€»è¾‘):
  GameStateå¯¹è±¡
    â””â”€> sunCount: int (è¿è¡Œæ—¶é˜³å…‰å€¼)
         åœ°å€: åŠ¨æ€ (GCç®¡ç†)

JNIå±‚ (Java â†” C++ æ¡¥æ¥):
  - æ¸²æŸ“å›è°ƒ
  - äº‹ä»¶ä¼ é€’
  - èµ„æºåŠ è½½

C++å±‚ (libpvz.so - æ¸¸æˆå¼•æ“/æ¸²æŸ“):
  LawnApp
    â””â”€> Board (å…³å¡ç®¡ç†)
         â””â”€> åˆå§‹é˜³å…‰é…ç½® (+0xE7C)
  
é€šä¿¡: Java â†’ JNI â†’ C++ (å•å‘ï¼Œç”¨äºæ¸²æŸ“æ›´æ–°)
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### æ–¹æ¡ˆA: Javaå±‚å¯¹è±¡åˆ†æ (æ¨è)

**å·¥å…·**: Frida

**æ­¥éª¤**:
1. æšä¸¾Javaå †ä¸­çš„æ‰€æœ‰å¯¹è±¡
2. æŸ¥æ‰¾åŒ…å«å½“å‰é˜³å…‰å€¼çš„å¯¹è±¡
3. è·å–è¯¥å¯¹è±¡çš„ç±»åå’Œå­—æ®µå
4. Hookè¯¥å­—æ®µçš„getter/setter

**ç¤ºä¾‹è„šæœ¬**:
```javascript
Java.perform(function() {
    // æœç´¢åŒ…å«é˜³å…‰å€¼çš„Javaå¯¹è±¡
    Java.choose("com.ea.game.pvzfree_cn.*", {
        onMatch: function(instance) {
            try {
                var fields = instance.class.getDeclaredFields();
                for (var i = 0; i < fields.length; i++) {
                    var field = fields[i];
                    if (field.getType().toString() === "int") {
                        field.setAccessible(true);
                        var value = field.getInt(instance);
                        if (value >= 0 && value <= 9990) {
                            console.log("Found potential sun: " + 
                                       field.getName() + " = " + value);
                        }
                    }
                }
            } catch(e) {}
        },
        onComplete: function() {}
    });
});
```

### æ–¹æ¡ˆB: åç¼–è¯‘APK

**å·¥å…·**: jadx-gui

**æ­¥éª¤**:
1. è§£åŒ…APK
2. åç¼–è¯‘DEXæ–‡ä»¶
3. æœç´¢é˜³å…‰ç›¸å…³çš„Javaç±»
4. æ‰¾åˆ°å­˜å‚¨é˜³å…‰çš„å­—æ®µ

### æ–¹æ¡ˆC: åŠ¨æ€è·Ÿè¸ªJavaå¯¹è±¡

**å·¥å…·**: Android Studio Profiler + Rootæƒé™

**æ­¥éª¤**:
1. Attachåˆ°æ¸¸æˆè¿›ç¨‹
2. è¿›å…¥Heap Dump
3. æœç´¢å€¼ä¸ºå½“å‰é˜³å…‰æ•°çš„intå­—æ®µ
4. æ¶ˆè€—é˜³å…‰åå†æ¬¡æœç´¢
5. ç¡®å®šå¯¹è±¡ç±»å‹å’Œå­—æ®µ

### æ–¹æ¡ˆD: ç»§ç»­C++åˆ†æ (ä½ä¼˜å…ˆçº§)

**ç›®æ ‡**: æ‰¾åˆ°LawnAppå…¨å±€å®ä¾‹

**æ–¹æ³•**:
1. åœ¨IDAä¸­æŸ¥æ‰¾æ‰€æœ‰å¯¹`sub_674C24` (MakeNewBoard)çš„äº¤å‰å¼•ç”¨
2. å‘ä¸Šè¿½æº¯è°ƒç”¨é“¾ï¼Œæ‰¾åˆ°LawnAppçš„åˆ›å»ºç‚¹
3. æŸ¥çœ‹æ˜¯å¦æœ‰å…¨å±€å˜é‡å­˜å‚¨
4. æ£€æŸ¥JNIå‡½æ•°ï¼Œçœ‹Javaå±‚å¦‚ä½•è°ƒç”¨C++å±‚

---

## ğŸ“ å…³é”®ç¬¦å·å’Œåœ°å€

### C++ç±»
```
Boardæ„é€ å‡½æ•°:          0x606834
Boardææ„å‡½æ•°:          0x60907C
Board vtable:           0x1B13B20
LawnApp::MakeNewBoard: 0x674C24
LawnApp vtable:         0x1B159C8
PvZApplication vtable:  0x1AF5E38
```

### é…ç½®è§£æ
```
sub_69C5C8:             0x69C5C8  (XMLè§£æ)
å…³å¡æ•°æ®åˆå§‹é˜³å…‰åç§»:   +0xE7C (3708)
mStartingSunå­—ç¬¦ä¸²:     0x177AA84
```

### Javaç›¸å…³
```
é˜³å…‰å€¼ç¤ºä¾‹åœ°å€:         0x7ACC02887C (è¿è¡Œæ—¶å˜åŒ–)
ä¸­é—´Javaå¯¹è±¡:           0x30b0338 (è¿è¡Œæ—¶å˜åŒ–)
è®¿é—®ä»£ç :               boot-framework.oat @ 0x71e51048
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [PVZé˜³å…‰ç³»ç»Ÿåˆ†æ](../doce/PVZ_SunSystem_Analysis.md) - é…ç½®çº§åˆ«åˆ†æ
- [Fridaè„šæœ¬é›†](../doce/PVZ_Frida_Scripts.md) - Javaå±‚Hookç¤ºä¾‹
- [å®Œæ•´ä¿®æ”¹æŒ‡å—](../doce/PVZ_Complete_ModGuide.md) - ä¿®æ”¹æ–¹æ³•æ±‡æ€»

---

## ğŸ“Œ é‡è¦æç¤º

**å¯¹äºå®é™…ä¿®æ”¹/ä½œå¼Šéœ€æ±‚**:
- âœ… **æ¨è**: ä½¿ç”¨GGç›´æ¥å†…å­˜æœç´¢ä¿®æ”¹ (æœ€ç®€å•)
- âœ… **æ¨è**: ä½¿ç”¨Frida Hook Javaå±‚ (ç¨³å®šä¸”å¯ç¼–ç¨‹)
- âš ï¸ **ä¸æ¨è**: å¯»æ‰¾C++é™æ€åŸºåœ°å€ (å¯èƒ½ä¸å­˜åœ¨)

**å¯¹äºå­¦ä¹ /ç ”ç©¶ç›®çš„**:
- ç»§ç»­Javaå±‚åˆ†ææ›´æœ‰ä»·å€¼
- å¯ä»¥å­¦ä¹ JNIäº¤äº’æœºåˆ¶
- ç†è§£Androidæ¸¸æˆæ¶æ„è®¾è®¡

---

*åˆ†æäººå‘˜: AI Assistant*  
*IDA Proç‰ˆæœ¬: 9.1*  
*ç›®æ ‡: libpvz.so (ARM64)*  
*çŠ¶æ€: C++å±‚åˆ†æå·²è¾¾ç“¶é¢ˆï¼Œå»ºè®®è½¬å‘Javaå±‚*

