cmake_minimum_required(VERSION 3.18.1)

project(memoryaccess)

add_library(memoryaccess SHARED
    memory_access.cpp
)

add_executable(memtool
    memtool.cpp
)

# æ·»åŠ åŸºäº/proc/memçš„ç‰ˆæœ¬ï¼ˆç±»ä¼¼CE ceserverï¼Œé¿å…ptraceï¼‰
add_executable(memtool_procmem
    memtool_procmem.cpp
)

find_library(log-lib log)

target_link_libraries(memoryaccess
    ${log-lib}
)

# é…ç½®Capstoneåæ±‡ç¼–å¼•æ“
# CMAKE_SOURCE_DIR = .../app/src/main/cpp
# å‘ä¸Š3çº§åˆ°é¡¹ç›®æ ¹ï¼Œç„¶åå®šä½jniLibs
set(CAPSTONE_LIB_PATH "${CMAKE_SOURCE_DIR}/../jniLibs/${ANDROID_ABI}/libcapstone.so")
set(CAPSTONE_INCLUDE_DIR "${CMAKE_SOURCE_DIR}/capstone")

message(STATUS "ğŸ” æ£€æŸ¥Capstoneåº“")
message(STATUS "  PROJECT_ROOT = ${PROJECT_ROOT}")
message(STATUS "  CAPSTONE_LIB_PATH = ${CAPSTONE_LIB_PATH}")
message(STATUS "  ANDROID_ABI = ${ANDROID_ABI}")
message(STATUS "  EXISTS = ${CAPSTONE_LIB_PATH}")

if(EXISTS ${CAPSTONE_LIB_PATH})
    message(STATUS "âœ… Found Capstone library: ${CAPSTONE_LIB_PATH}")
    message(STATUS "âœ… Capstone headers: ${CAPSTONE_INCLUDE_DIR}")
    
    # æ·»åŠ Capstoneå¤´æ–‡ä»¶è·¯å¾„
    target_include_directories(memtool PRIVATE ${CAPSTONE_INCLUDE_DIR})
    
    # å¯¼å…¥Capstoneåº“
    add_library(capstone SHARED IMPORTED)
    set_target_properties(capstone PROPERTIES IMPORTED_LOCATION ${CAPSTONE_LIB_PATH})
    
    # é“¾æ¥Capstone
    target_link_libraries(memtool capstone)
    
    # å®šä¹‰HAVE_CAPSTONEå®
    target_compile_definitions(memtool PRIVATE HAVE_CAPSTONE)
    
    message(STATUS "âœ… Capstone enabled for memtool with disasm support")
else()
    message(WARNING "âŒ Capstone library not found at ${CAPSTONE_LIB_PATH}")
    message(WARNING "   Disasm functionality will be disabled")
endif()

# ä¸ºmemtool_procmemé…ç½®Capstoneï¼ˆå¼ºåˆ¶é…ç½®ARM64/ARMv7ï¼‰
if(ANDROID_ABI STREQUAL "arm64-v8a" OR ANDROID_ABI STREQUAL "armeabi-v7a")
    message(STATUS "ğŸ”§ é…ç½®memtool_procmemçš„Capstoneï¼ˆ${ANDROID_ABI}ï¼‰")
    target_include_directories(memtool_procmem PRIVATE ${CAPSTONE_INCLUDE_DIR})
    add_library(capstone_procmem SHARED IMPORTED)
    set_target_properties(capstone_procmem PROPERTIES IMPORTED_LOCATION ${CAPSTONE_LIB_PATH})
    target_link_libraries(memtool_procmem capstone_procmem)
    target_compile_definitions(memtool_procmem PRIVATE HAVE_CAPSTONE)
    message(STATUS "âœ… Capstone enabled for memtool_procmem")
endif()

set_target_properties(memtool PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_LIBRARY_OUTPUT_DIRECTORY}"
)

set_target_properties(memtool_procmem PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_LIBRARY_OUTPUT_DIRECTORY}"
)

